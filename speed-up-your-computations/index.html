<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Speed Up Your Computations | Dev Journal</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Speed Up Your Computations" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Blogging about interests." />
<meta property="og:description" content="Blogging about interests." />
<link rel="canonical" href="https://earezki.com/speed-up-your-computations/" />
<meta property="og:url" content="https://earezki.com/speed-up-your-computations/" />
<meta property="og:site_name" content="Dev Journal" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-11T04:49:46+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Speed Up Your Computations" />
<script type="application/ld+json">
{"description":"Blogging about interests.","url":"https://earezki.com/speed-up-your-computations/","@type":"BlogPosting","headline":"Speed Up Your Computations","dateModified":"2017-09-11T04:49:46+00:00","datePublished":"2017-09-11T04:49:46+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://earezki.com/speed-up-your-computations/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://earezki.com/feed.xml" title="Dev|Journal" /><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161447264-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161447264-1');
</script> </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Dev|Journal</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Speed Up Your Computations</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-09-11T04:49:46+00:00" itemprop="datePublished">Sep 11, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img src="/assets/speed_up_your_computations.jpg" alt="Speed Up Your Computations" title="Speed Up Your Computations" /></p>

<p>Sometimes you find yourself trying to squeeze the last bits of your CPU to give you some more milliseconds. Or you may hate the smell of a melting CPU. Or maybe you are just a performance maniac. If you happen to be in one of these cases, keep reading this post.</p>

<p>So let us say you are designing a banking application in which you have a Transaction entity, and let us say that the entity contains these simple fields.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Transaction</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">TransactionId</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Money</span> <span class="n">amount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">AccountId</span> <span class="n">debit</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">AccountId</span> <span class="n">credit</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The Money would, simple holding only the value itself as:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Money</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">double</span> <span class="n">value</span><span class="o">;</span>

    <span class="nc">Money</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Money</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Money</span><span class="o">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>And then you have an account with a liste of all the transactions that it has made.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">AccountId</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Transaction</span><span class="o">&gt;</span> <span class="n">transactions</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Now you are tasked to calculate the total amount of those transactions. A simple functional solution with java 8 streams would be:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="nc">Money</span> <span class="nf">total</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">transactions</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Transaction:</span><span class="o">:</span><span class="n">amount</span><span class="o">)</span>
            <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="nc">Money</span><span class="o">.</span><span class="na">ZERO</span><span class="o">,</span> <span class="nl">Money:</span><span class="o">:</span><span class="n">add</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>You test it and it works. The next day, your colleagues start to complain about performance, and given there are millions of transactions, the profiler points to your method.</p>

<p>What are you going to do now? Hmm, let me see, yeah, I got it, parallelism to the rescue. You take this great idea to your colleagues and they turn you down because the server is already filled with active threads. Now what? Well, you just need to better use your cycles (bear the word).</p>

<p>Let’s change the structure of the Transaction entity.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Transactions</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">TransactionId</span><span class="o">[]</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Moneys</span> <span class="n">amount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">AccountId</span><span class="o">[]</span> <span class="n">debit</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">AccountId</span><span class="o">[]</span> <span class="n">credit</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">transactionsCount</span><span class="o">;</span>

    <span class="nc">Money</span> <span class="nf">total</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Money</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">Money</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>Notice the name that is transactions (with an S), and also the entity holds arrays rather than single objects.</p>

<p>Now the Account will hold this new Transactions object instead of the Transaction list.</p>

<p>Then the calculation becomes:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Transactions</span> <span class="n">transactions</span><span class="o">;</span>

    <span class="nc">Money</span> <span class="nf">total</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">return</span> <span class="n">transactions</span><span class="o">.</span><span class="na">total</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span> 
</code></pre></div></div>
<p>Nothing wrong with this code, always OOP !</p>

<p>We also changed the Amount class, the new object (Amounts) hold an array of values (primitive double array).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Moneys</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">double</span><span class="o">[]</span> <span class="n">values</span><span class="o">;</span>

    <span class="nc">Money</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Money</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">values</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Money</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>On my machine and after warming the JVM for a million rounds, this implementation is around 32X faster than the previous one (test the code for yourselves on <a href="https://github.com/earezki/speedup-computations">Github</a>) and share your results).</p>

<p>Now, why this is faster? It turns out that modern CPUs work better when all the calculation is applied on data that is packed together. The CPU reads data from the memory in cache lines (it is around 64KB in most CPUs) and stores it in the L1 cache. When the CPU wants to fetch data, it will compare its address to the address space in the L1 then L2 then L3 caches. If the address is not there, the CPU will read a whole cache line starting from the nearest alignment to the needed address and store it in the L1 cache (in this example, the CPU will load all the attributes of the Transaction to use the amount attribute).</p>

<p>The first example suffers a lot from cache miss, which means the CPU reads a lot of data that it doesn’t need, then throws it away, and then reads more data that it won’t need.</p>

<p>One more advantage is that this approach fits naturally with SIMD operations (Kinda hard to use in java anyway, but the compiler may chose to optimize the code to use it).</p>

<p>To a give an example, the read from the L1 cache in Intel i7 5500 takes around 4 cycles for simple access, whereas a read from main memory takes around 120 cycles.</p>

<p>Now you have it; most of the time, you probably won’t use it, this technique is heavily used in the game development industry, and in embedded systems.</p>

<p>And to make a disclaimer, you may not benefit from this approach in a large web app, because other scheduled threads will pollute the cache anyway, and your best bet is the large shared L3 cache (for Intel, at least).</p>


  </div><a class="u-url" href="/speed-up-your-computations/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Dev|Journal</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Dev|Journal</li><li><a class="u-email" href="mailto:arezki.elmehdi@gmail.com">arezki.elmehdi@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/earezki"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">earezki</span></a></li><li><a href="https://www.linkedin.com/in/mehdi-arezki"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">mehdi-arezki</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blogging about interests.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
